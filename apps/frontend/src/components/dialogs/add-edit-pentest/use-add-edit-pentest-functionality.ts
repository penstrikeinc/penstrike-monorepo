import { UseFormReturn } from 'react-hook-form';
import { Dispatch, MouseEventHandler, SetStateAction, useCallback, useEffect } from 'react';
import { AxiosResponse } from 'axios';
import { assetsDefaultValues, pentestDefaultValues, TAssets, TPentest } from 'src/schemas';
import { useCreatePentestMutation } from 'src/services';
import { ICompletedStateProps } from './step-components/type';

export interface IParams {
  onClose: () => void;
  isEditMode: boolean;
  activeStep: number;
  setActiveStep: Dispatch<SetStateAction<number>>;
  setCompleted: Dispatch<SetStateAction<ICompletedStateProps>>;
  onSuccess?: (data: AxiosResponse<any>) => void;
  onError?: (error: unknown) => void;
  completed: ICompletedStateProps;
  methods: UseFormReturn<TPentest>;
  assetMethods: UseFormReturn<TAssets>;
}

export const useAddEditPentestFunctionality = (params: IParams) => {
  const {
    onClose,
    isEditMode,
    activeStep,
    setActiveStep,
    setCompleted,
    onSuccess,
    onError,
    completed,
    methods,
    assetMethods,
  } = params;

  const { mutateAsync: createPentest } = useCreatePentestMutation();

  const {
    reset,
    formState: { isValid },
    handleSubmit,
  } = methods;

  const {
    reset: resetAsset,
    formState: { isValid: isValidAsset },
    getValues: getValuesAsset,
  } = assetMethods;

  const { assets } = getValuesAsset();

  const isMutationLoading = false;
  const isDisabled = Boolean(activeStep === 0 ? !isValid : !isValidAsset);
  const isEnableSaveBtn = Boolean(isValid && isValidAsset);

  const onCloseHandler = useCallback(() => {
    reset(pentestDefaultValues);
    resetAsset(assetsDefaultValues);
    setActiveStep(0);
    setCompleted({});
    onClose();
  }, [onClose, reset, resetAsset, setActiveStep, setCompleted]);

  const handleComplete = useCallback(() => {
    const newCompleted = completed;

    if (isValid) {
      newCompleted[0] = true;
    }
    if (isValidAsset) {
      newCompleted[1] = true;
    }
    if (isEnableSaveBtn) {
      newCompleted[0] = true;
      newCompleted[1] = true;
      newCompleted[2] = true;
    }
    if (!isEnableSaveBtn) {
      newCompleted[2] = false;
    }

    setCompleted(newCompleted);
  }, [completed, isEnableSaveBtn, isValid, isValidAsset, setCompleted]);

  useEffect(() => {
    // if (isEditMode) {
    //   handleComplete();
    // }
  }, [handleComplete, isEditMode]);

  const onUpdateSupplierSubmit = useCallback(async (data: any) => {
    console.log({ data });
  }, []);

  const onCreatePentestSubmit = useCallback(
    async (pentest: TPentest) => {
      if (!assets) {
        return;
      }
      createPentest(
        { pentest, assets },
        {
          onSuccess: (res) => {
            onCloseHandler();
          },
          onError: (error) => {
            if (onError) {
              onError(error);
            }
          },
        }
      );
    },
    [assets, createPentest, onCloseHandler, onError]
  );

  const handleNext = useCallback(() => {
    setActiveStep(activeStep + 1);
    handleComplete();
  }, [activeStep, handleComplete, setActiveStep]);

  const handleBack = useCallback(() => {
    setActiveStep((prevActiveStep: number) => prevActiveStep - 1);
    handleComplete();
  }, [handleComplete, setActiveStep]);

  const handleStep = useCallback(
    (step: number) => () => {
      setActiveStep(step);

      handleComplete();
    },
    [handleComplete, setActiveStep]
  );

  const onCloseDialogHandler = useCallback(
    (_event: MouseEventHandler<HTMLButtonElement>, reason: 'escapeKeyDown' | 'backdropClick') => {
      if (reason === 'backdropClick') {
        return;
      }
      onCloseHandler();
    },
    [onCloseHandler]
  );

  const onSubmit = isEditMode ? onUpdateSupplierSubmit : onCreatePentestSubmit;

  return {
    onSubmit: handleSubmit(onSubmit),
    onCloseHandler,
    onCloseDialogHandler,
    methods,
    handleBack,
    handleNext,
    handleStep,
    isDisabled,
    isMutationLoading,
    isEnableSaveBtn,
  };
};
